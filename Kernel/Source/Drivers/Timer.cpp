////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#ifndef _TIMER_C_
#define _TIMER_C_
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
    System timer installer and handlers.
*/
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "../Lib/STDLib.H"

#include "IRQ.H"
#include "Timer.H"

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

uint ulTimerTicks = 0;
uint ulTimerResets = 0;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

uint GetTickCount(void)
{
    return (uint) (((double)((ulTimerTicks * (ulTimerResets + 1)) * 1000)) / SYSTEMTICKSPERSECOND);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
    Handles the timer. In this case, it's very simple: We
    increment the 'ulTimerTicks' variable every time the
    timer fires. By default, the timer fires 18.222 times
    per second.
*/
void TimerHandler(struct regs *r)
{
    if(ulTimerTicks++ == MAXSYSTEMTICKS)
    {
        ulTimerTicks = 0;
        ulTimerResets++;
    }
    /*
    if((ulTimerTicks % 18) == 0)
    {
        printf("1 Second has elapsed.\n");
    }
    */
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//This will continuously loop until the given time has been reached
void Sleep(uint uiMilliSeconds)
{
    TimerWait(uiMilliSeconds);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//This will continuously loop until the given time has been reached

void TimerWait(uint ulTicks)
{
    uint ulCountTo = ulTimerTicks + ulTicks;
    while(ulTimerTicks < ulCountTo);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*
    Sets up the system clock by installing the timer handler into IRQ0
*/
bool Timer_Install(void)
{
	/* Installs 'TimerHandler' to IRQ0 */
    IRQ_Install_Handler(0, TimerHandler);
    return true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#endif
